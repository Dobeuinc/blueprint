#!/usr/bin/env node
'use strict';

var program = require ('commander')
  , path = require ('path')
  , winston = require ('winston')
  , async = require ('async')
  , lib = require ('../lib')
  ;

var Installer = lib.Installer
  , ModulesFile = lib.ModulesFile
  ;

program
  .arguments ('<module-name>')
  .parse (process.argv);

var currPath = process.cwd ();
var moduleFilePath = path.resolve (currPath, 'app/modules.js');

// Run the npm installer to install the module in the application. Then,
// open the module file and add this module to the list.
async.waterfall ([
  function (callback) { Installer (currPath, {save: true}, callback); },
  function (installer, callback) { installer.install ([program.args[0]], callback); },
  function (result, node, callback) { ModulesFile (moduleFilePath, callback); },
  function (modulesFile, callback) {
    modulesFile.addToSet (program.args[0], function (err, added) {
      return callback (err, modulesFile, added);
    });
  },
  function (modulesFiles, updated, callback) {
    if (updated) return modulesFiles.save (callback);
    return callback (null);
  }
], completionHandler ('successfully installed module'));

function completionHandler (msg) {
  return function (err) {
    if (err)
      winston.log ('error', util.inspect (err));
    else
      winston.log ('info', msg);
  }
}
